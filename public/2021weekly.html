<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Home-centered gospel study </title>
    <!--<script src=".js"></script>-->
    <!--<link rel="stylesheet" type="text/css" href=".css">-->
    <style>
      body { 
        background-color: rgb(150, 150, 150);
        /* background-image: url("joseph.jpg"); */
        background-blend-mode: screen;
        background-size: cover;
        background-position: top;
        background-repeat: no-repeat;
        color: rgb(40, 40, 40);
        text-align: center;

      }

      table { 
        margin: auto;
        text-align: left;
      }
      
      .col1 { 
        text-align: right;
        padding: 6px;
        width: 50px;
        font-variant: small-caps;
      }

      tr { 
        font-weight: 800;
        
      }

      h1 { 
        margin: 3px;
      }

      h3 { 
        margin: 9px;
      }

      a { 
        color: inherit;
        text-decoration: unset;
      }

      input { 
        padding: 4px;
        background: rgb(239, 245, 188);
        color: rgb(138, 138, 138);
      }

    </style>
  </head>

<body onload="loadFirst()">

<h1>Lesson Plan</h1>

<form id="agenda">
  <input type="button" value="Click to load this week" onclick="load(getWeek())">
  <h3 id="dates"></h3>
  <table>
    <!--<tr><th class="col1"><th></th></tr>-->

    <tr><td class="col1">Conducting</td><td id="conduct"></td></tr>
    <tr><td class="col1">Family announcements</td><td id="announce" onclick="editItem(this)">Love one Another</td></tr>
    <tr><td class="col1">Opening Song</td><td id="osong"></td></tr>
    <tr><td class="col1">Opening Prayer</td><td id="oprayer"></td></tr>
    <tr><td class="col1">Lesson</td><td id="teacher"></td></tr>
    <tr><td class="col1">Closing Song</td><td id="csong"></td></tr>
    <tr><td class="col1">Closing Prayer</td><td id="cprayer"></td></tr>
    <tr><td class="col1"></td><td></td></tr>
    <tr><td class="col1"></td><td></td></tr>
    <tr><td class="col1">Topic</td><td id="topic"><a href="https://www.churchofjesuschrist.org/study/manual/come-follow-me-for-individuals-and-families-new-testament-2019/41?lang=eng" target="_blank">Be kind, tell the truth...</a></td></tr>
    <tr><td class="col1">Priesthood/
      Relief Society</td><td id="prs"></td></tr>
    <tr><td class="col1">Scriptures</td><td id="scripture"><a href="https://www.churchofjesuschrist.org/study/scriptures/nt?lang=eng" style="text-decoration: unset;" target="_blank">Book of Mormon</a></td></tr>
  </table>
  <input type="button" value="Click to load next week" onclick="load(getWeek() + 1)">
</form>

<form action="2021schedule.html">
  <div id='debug'></div>
  <p></p>
  <input type="submit" value="2021 Schedule">
  
</form>
<footer id="date">
</footer>
  

<script>
  function loadFirst() { 
    if (sessionStorage.getItem("week")) {
      week = parseInt(sessionStorage.getItem("week"));
      load(week);
    } else {
      load(getWeek());
    }
  };

  function load(week) { 

  //get the data from the database
  var xmlHttpRequest = new XMLHttpRequest();
  xmlHttpRequest.onreadystatechange = function() {
    if (xmlHttpRequest.readyState == XMLHttpRequest.DONE && xmlHttpRequest.status == 200 ) {
 
      console.log('inside xmlHttpResquet');
      var data = JSON.parse(xmlHttpRequest.responseText);

      // add the database to the webpage
      document.getElementById("dates").innerHTML = data.dates[week - 1].weekname;
      document.getElementById("conduct").innerHTML = data.family[(week + 2) % 5].firstname;
      document.getElementById("teacher").innerHTML = data.family[(week + 4) % 5].firstname;
      document.getElementById("cprayer").innerHTML = data.family[(week + 0) % 5].firstname;
      document.getElementById("oprayer").innerHTML = data.family[(week + 1) % 5].firstname; 

      document.getElementById("topic").innerHTML = '<a href="https://www.churchofjesuschrist.org/study/manual/come-follow-me-for-individuals-and-families-doctrine-and-covenants-2021/' + addZero(week) + '?lang=eng" target="_blank">' + data.topic[0].title +'</a>';

      document.getElementById("scripture").innerHTML = '<a href="https://www.churchofjesuschrist.org/study/scriptures/dc-testament/dc/' + data.scriptLink[0].linkname + '?lang=eng" target="_blank">' + data.scriptures[0].scriptname +'</a>';

      document.getElementById("osong").innerHTML = '<a href=' + data.music[data.oSong[0].book - 1].name + ' target="_blank">' + getMusicLink(data.oSong[0]) + " " + '</a>';

      document.getElementById("csong").innerHTML = 
      '<a href=' + data.music[data.cSong[(week) % 6].book].name + ' target="_blank">' + getMusicLink(data.cSong[(week) % 6]) + '</a>';

      document.getElementById("announce").innerHTML = data.business[0].note;

      if (data.PRSLesson[0] == undefined) {
        document.getElementById("prs").innerHTML = "";
      } else {
        document.getElementById("prs").innerHTML = '<a href=' + data.PRSLesson[0].link + ' target="_blank"><em>' + data.PRSLesson[0].talkname + '</em>, by ' + data.PRSLesson[0].speaker + '</a>';
      }

      document.body.style.backgroundImage = "url('" + data.background[(week % data.background.length)].picture + "')";
      }

    }

    //the json is from the database here
    xmlHttpRequest.open('GET', 'https://nate-node.herokuapp.com/cfmweek?week=' + week, true);
    xmlHttpRequest.send();

  };

  // returns the yearly week number 0-52
  function getWeek() { 
    let now = new Date();
    let onejan = new Date(now.getFullYear(), 0, 1);

    if (now.getDay() > 5) { 
      return (Math.ceil( (((now - onejan) / 86400000) + onejan.getDay() + 1) / 7 ) - 2);      
    } else if (now.getDay() > 0) {
      return (Math.ceil( (((now - onejan) / 86400000) + onejan.getDay() + 1) / 7 ) - 2) + 1;      
    } 

    return (Math.ceil( (((now - onejan) / 86400000) + onejan.getDay() + 1) / 7 ) - 2);
  };

  // add a preceding zero to single digits, if necessary
  function addZero(week) {
    if (week < 10) {
      return '0' + week;
    } else {
      return week;
    }
  };

  // edit music link based on if the music is a hymn or not 
  function getMusicLink(music) {
    if (music.book == 1) {
      return ("Hymn number " + music.number + ", <em>" + music.name + "</em>");
    } else {
      return ("<em>" + music.name + "</em>, from the Children's Songbook, page " + music.number);
    }
  };

  // edit DOM for announcement section 
  function editItem(item) {
    var edit = document.getElementById('announce');
    var box = document.createElement('input');
    box.setAttribute("type", "text");
    box.setAttribute("id", "announceInput");
    box.setAttribute("value", item.innerText);

    var button = document.createElement('input');
    button.setAttribute("type", "button");
    button.setAttribute("onclick", "addBusiness()");
    button.setAttribute("value", "Done");

    edit.parentElement.childNodes[1].innerText = "";
    edit.parentElement.childNodes[1].removeAttribute("onclick");

    edit.appendChild(box);
    edit.appendChild(button);
    document.getElementById('announce').childNodes[0].focus();
  };

  function addBusiness() {
    //add the data to the database
    var xmlHttpRequest = new XMLHttpRequest();
    xmlHttpRequest.onreadystatechange = function() {
      if (xmlHttpRequest.readyState == XMLHttpRequest.DONE && xmlHttpRequest.status == 200 ) {
        var data = JSON.parse(xmlHttpRequest.responseText);

        data.business[getWeek()].note = document.getElementById('announce').innerHTML;

      }

    }
    xmlHttpRequest.open('POST', 'https://nate-node.herokuapp.com/add', true);
    xmlHttpRequest.send();

    document.getElementById('announce').innerText = document.getElementById('announceInput').innerText;
  };

</script>
</body>
</html>